name: Publish to MCP Registry

on:
  release:
    types: [published]
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0
  workflow_dispatch:  # Allow manual triggering

jobs:
  publish-mcp:
    runs-on: ubuntu-latest
    needs: []  # Run independently, but typically after PyPI publish
    permissions:
      id-token: write  # Required for OIDC authentication
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install MCP Publisher
        run: |
          # Get the latest version of mcp-publisher
          LATEST_VERSION=$(curl -s https://api.github.com/repos/modelcontextprotocol/registry/releases/latest | jq -r '.tag_name')
          echo "Installing mcp-publisher version: $LATEST_VERSION"
          curl -L "https://github.com/modelcontextprotocol/registry/releases/download/${LATEST_VERSION}/mcp-publisher_${LATEST_VERSION#v}_linux_amd64.tar.gz" | tar xz mcp-publisher
          chmod +x mcp-publisher
          ./mcp-publisher --version

      - name: Extract version from pyproject.toml
        id: version
        run: |
          VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Update server.json with current version
        run: |
          # Update the version in server.json to match pyproject.toml
          python -c "
          import json
          import tomllib
          
          # Read version from pyproject.toml
          with open('pyproject.toml', 'rb') as f:
              pyproject = tomllib.load(f)
          version = pyproject['project']['version']
          
          # Update server.json
          with open('server.json', 'r') as f:
              server_config = json.load(f)
          
          server_config['version'] = version
          server_config['packages'][0]['version'] = version
          
          with open('server.json', 'w') as f:
              json.dump(server_config, f, indent=2)
          
          print(f'Updated server.json to version {version}')
          "

      - name: Validate server.json
        run: |
          # Install ajv-cli for JSON schema validation
          npm install -g ajv-cli
          # Validate against the MCP server schema
          ajv validate -s https://static.modelcontextprotocol.io/schemas/2025-09-16/server.schema.json -d server.json

      - name: Login to MCP Registry
        run: ./mcp-publisher login github-oidc

      - name: Publish to MCP Registry
        run: ./mcp-publisher publish

      - name: Verify publication
        run: |
          echo "MCP server published successfully!"
          echo "You can view it at: https://mcp.registry.io/io.github.conductor-oss/conductor-mcp"
